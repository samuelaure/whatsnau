services:
  app:
    image: ghcr.io/samuelaure/whatsnau-backend:latest
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Infrastructure (Required)
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}?schema=public
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      
      # Security (Required)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      
      # Telegram (System-level - Required)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_SYSTEM_CHAT_ID=${TELEGRAM_SYSTEM_CHAT_ID}
      
      # Meta App (Optional - for Embedded Signup)
      - META_APP_ID=${META_APP_ID:-}
      - META_APP_SECRET=${META_APP_SECRET:-}
      
      # Platform
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DASHBOARD_URL=${DASHBOARD_URL}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD:-admin123}
      
      # WhatsApp Provider
      - WHATSAPP_PROVIDER=${WHATSAPP_PROVIDER:-meta}
      - WHATSAPP_VERSION=${WHATSAPP_VERSION:-v18.0}
      
      # WhatsApp (Tenant-scoped - Optional fallback)
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID:-}
      - WHATSAPP_PHONE_NUMBER=${WHATSAPP_PHONE_NUMBER:-}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID:-}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN:-}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN:-}
      
      # YCloud (Tenant-scoped - Optional fallback)
      - YCLOUD_API_KEY=${YCLOUD_API_KEY:-}
      
      # OpenAI (Tenant-scoped - Optional fallback)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - PRIMARY_AI_MODEL=${PRIMARY_AI_MODEL:-gpt-4o}
      - CHEAP_AI_MODEL=${CHEAP_AI_MODEL:-gpt-4o-mini}
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    image: ghcr.io/samuelaure/whatsnau-backend:latest
    command: npm run start:worker:prod
    restart: always
    environment:
      # Infrastructure (Required)
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}?schema=public
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      
      # Security (Required)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      
      # Telegram (System-level - Required)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_SYSTEM_CHAT_ID=${TELEGRAM_SYSTEM_CHAT_ID}
      
      # Meta App (Optional - for Embedded Signup)
      - META_APP_ID=${META_APP_ID:-}
      - META_APP_SECRET=${META_APP_SECRET:-}
      
      # Platform
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DASHBOARD_URL=${DASHBOARD_URL}
      
      # WhatsApp Provider
      - WHATSAPP_PROVIDER=${WHATSAPP_PROVIDER:-meta}
      - WHATSAPP_VERSION=${WHATSAPP_VERSION:-v18.0}
      
      # WhatsApp (Tenant-scoped - Optional fallback)
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID:-}
      - WHATSAPP_PHONE_NUMBER=${WHATSAPP_PHONE_NUMBER:-}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID:-}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN:-}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN:-}
      
      # YCloud (Tenant-scoped - Optional fallback)
      - YCLOUD_API_KEY=${YCLOUD_API_KEY:-}
      
      # OpenAI (Tenant-scoped - Optional fallback)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - PRIMARY_AI_MODEL=${PRIMARY_AI_MODEL:-gpt-4o}
      - CHEAP_AI_MODEL=${CHEAP_AI_MODEL:-gpt-4o-mini}
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
