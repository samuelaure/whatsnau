// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  isDemo    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  campaigns         Campaign[]
  leads             Lead[]
  tags              Tag[]
  whatsAppConfigs   WhatsAppConfig[]
  leadImportBatches LeadImportBatch[]
  stagingLeads      StagingLead[]
  globalConfigs     GlobalConfig[]
  businessProfiles  BusinessProfile[]
  telegramConfigs   TelegramConfig[]
  takeoverKeywords  TakeoverKeyword[]
  orders            Order[]
  products          Product[]
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  sku         String?
  isActive    Boolean  @default(true)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items OrderItem[]

  @@index([tenantId])
}

model Order {
  id              String   @id @default(uuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id])
  status          String   @default("DRAFT") // DRAFT, PENDING, COMPLETED, CANCELLED
  totalAmount     Float    @default(0)
  currency        String   @default("EUR")
  deliveryAddress String?
  notes           String?
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items OrderItem[]

  @@index([tenantId])
  @@index([leadId])
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)
  unitPrice Float

  @@index([orderId])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hashed
  name      String?
  role      String   @default("ADMIN") // ADMIN, VIEWER
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Campaign {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leads         Lead[]
  stages        CampaignStage[]
  tags          Tag[]
  importBatches LeadImportBatch[]
  prompts       PromptConfig[]

  whatsAppConfigId String?
  whatsAppConfig   WhatsAppConfig? @relation(fields: [whatsAppConfigId], references: [id])

  @@index([tenantId])
  @@index([tenantId, isActive])
}

model WhatsAppConfig {
  id            String   @id @default(uuid())
  phoneNumberId String   @unique
  wabaId        String
  accessToken   String // Permanent Access Token
  phoneNumber   String?
  displayName   String?
  isDefault     Boolean  @default(false)
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaigns Campaign[]

  @@index([tenantId])
}

model CampaignStage {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  name      String // e.g., "M1-Pitch", "M2-FollowUp", "M3-WeeklyTipsInvite"
  order     Int // To sequence them
  waitHours Int    @default(0) // Time to wait before triggering if no response

  messageTemplates MessageTemplate[]
  leads            Lead[]            @relation("CurrentStage")
  createdAt        DateTime          @default(now())
}

model Lead {
  id              String  @id @default(uuid())
  phoneNumber     String
  name            String?
  status          String  @default("ACTIVE") // ACTIVE, HANDOVER, BLOCKED
  aiEnabled       Boolean @default(true)
  unansweredCount Int     @default(0) // New: track consecutive unanswered business messages
  tenantId        String
  tenant          Tenant  @relation(fields: [tenantId], references: [id])

  // State Machine Logic (Primary State)
  state          String         @default("COLD") // COLD, INTERESTED, DEMO, NURTURING, CLIENTS
  currentStageId String?
  currentStage   CampaignStage? @relation("CurrentStage", fields: [currentStageId], references: [id])

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  // Debouncing & AI State
  lastInboundAt  DateTime?
  isProcessingAI Boolean   @default(false)

  // Timestamps
  lastInteraction DateTime @default(now())
  createdAt       DateTime @default(now())

  // Flexible metadata (JSON)
  metadata String? // JSON string for business info, research data, etc.

  // Demo Specifics
  demoStartedAt DateTime?
  demoExpiresAt DateTime?
  demoMinutes   Int?      @default(10) // Configurable demo duration

  // Nurturing Specifics
  nurturingOptInAt            DateTime?
  nurturingOnboardingComplete Boolean   @default(false)
  lastBroadcastInteraction    DateTime?

  messages      Message[]
  tags          Tag[]
  summaries     ConversationSummary[]
  opportunities Opportunity[]
  orders        Order[]

  @@unique([tenantId, phoneNumber])
  @@index([tenantId])
  @@index([tenantId, state])
}

model Message {
  id     String @id @default(uuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id])

  direction String // INBOUND, OUTBOUND
  content   String
  type      String @default("TEXT") // TEXT, BUTTON_RESPONSE, TEMPLATE
  status    String @default("sent") // sent, delivered, read, failed

  timestamp DateTime @default(now())

  // Logic tracking
  whatsappId    String? @unique // To handle idempotency
  campaignStage String? // Reference to stage when sent
  aiGenerated   Boolean @default(false)
  wasRead       Boolean @default(false)
  isProcessed   Boolean @default(false)
}

model Tag {
  id          String    @id @default(uuid())
  name        String
  category    String    @default("SYSTEM") // SYSTEM, INTENT, CAMPAIGN, CUSTOM
  description String? // What this tag means
  campaignId  String?
  campaign    Campaign? @relation(fields: [campaignId], references: [id])
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  leads     Lead[]
  createdAt DateTime @default(now())

  @@unique([tenantId, name])
  @@index([tenantId])
}

model TakeoverKeyword {
  id        String   @id @default(uuid())
  word      String
  type      String   @default("INTERNAL") // INTERNAL (for owner), LEAD (for leads)
  category  String   @default("TAKEOVER") // TAKEOVER, REACTIVATION
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())

  @@unique([tenantId, word])
  @@index([tenantId])
}

model GlobalConfig {
  id                     String   @id
  availabilityStatus     String? // e.g. "meeting_until_1600"
  ownerName              String   @default("Samuel")
  recoveryTimeoutMinutes Int      @default(240) // Default 4 hours
  tenantId               String
  tenant                 Tenant   @relation(fields: [tenantId], references: [id])
  updatedAt              DateTime @updatedAt

  @@unique([tenantId])
}

model ConversationSummary {
  id     String @id @default(uuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id])

  content   String
  createdAt DateTime @default(now())
}

model BusinessProfile {
  id            String   @id
  name          String   @default("whatsnaŭ")
  knowledgeBase String? // Extensive context about the business
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  updatedAt     DateTime @updatedAt

  @@unique([tenantId])
}

model PromptConfig {
  id         String   @id @default(uuid())
  role       String // CLOSER, RECEPTIONIST, NURTURING
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  basePrompt String

  // Context injection rules
  includeLeadName            Boolean @default(true)
  includeLeadMetadata        Boolean @default(true)
  includeLeadTags            Boolean @default(true)
  includeConversationHistory Boolean @default(true)
  historyMessageCount        Int     @default(10)

  // Behavior settings
  temperature     Float   @default(0.7)
  usePremiumModel Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, campaignId])
}

// MASS OUTREACH MODELS
model LeadImportBatch {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  name        String // e.g., "Google Maps Scraping - Jan 20"
  status      String   @default("STAGING") // STAGING, ANALYZING, READY, EXECUTING, COMPLETED
  contentHash String?  @unique // SHA-256 hash of CSV content for deduplication
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())

  stagingLeads StagingLead[]

  @@index([tenantId])
}

model StagingLead {
  id      String          @id @default(uuid())
  batchId String
  batch   LeadImportBatch @relation(fields: [batchId], references: [id])

  rawData     String // JSON blob of original CSV row
  phoneNumber String
  name        String?
  email       String?
  website     String?

  // Cleanse/Analysis Status
  isValidWhatsApp Boolean @default(false)
  isVerified      Boolean @default(false) // Checked against WA API
  cleanseStatus   String  @default("PENDING") // PENDING, CLEANED, INVALID
  tenantId        String
  tenant          Tenant  @relation(fields: [tenantId], references: [id])

  opportunities Opportunity[]

  @@index([tenantId])
}

model Opportunity {
  id            String       @id @default(uuid())
  stagingLeadId String?
  stagingLead   StagingLead? @relation(fields: [stagingLeadId], references: [id])
  leadId        String?
  lead          Lead?        @relation(fields: [leadId], references: [id])

  type        String // NO_WEBSITE, FEW_REVIEWS, LOW_RATING, CUSTOM
  description String
  severity    String   @default("MEDIUM") // LOW, MEDIUM, HIGH (Priority)
  aiGenerated Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model TelegramConfig {
  id        String   @id
  botToken  String?
  chatId    String?
  isEnabled Boolean  @default(false)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  updatedAt DateTime @updatedAt

  @@unique([tenantId])
}

model MessageTemplate {
  id      String        @id @default(uuid())
  stageId String
  stage   CampaignStage @relation(fields: [stageId], references: [id])

  content String // Template with variables: "Hola {{name}}, ..."
  order   Int    @default(1) // For multi-message stages

  // Button support (for interactive messages)
  hasButtons Boolean @default(false)
  buttons    String? // JSON array of button configs

  // Link to Meta-approved WhatsApp template (for business-initiated messages)
  whatsappTemplate WhatsAppTemplate?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WhatsAppTemplate {
  id String @id @default(uuid())

  // Meta template info
  metaTemplateId String? @unique // Meta's template ID
  name           String  @unique // Template name in Meta
  status         String // APPROVED, PENDING, REJECTED, DISABLED
  category       String // MARKETING, UTILITY, AUTHENTICATION
  language       String  @default("es_ES")

  // Template structure from Meta
  components String // JSON: header, body, footer, buttons

  // Variable mapping (Meta {{1}} → Our {{name}})
  variableMapping String? // JSON: {"1": "name", "2": "business"}

  // Link to our internal template
  messageTemplateId String?          @unique
  messageTemplate   MessageTemplate? @relation(fields: [messageTemplateId], references: [id])

  // Metadata
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
